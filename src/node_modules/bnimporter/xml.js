var events = require('events'),
    fs = require('fs'),
    util = require('util'),
    XmlStream = require('xml-stream'),
    graphstore = require('bngraphstore'),
    Q = require('q');

graphstore.autocommit = false;

module.exports = XMLImporter;

function XMLImporter(options) {
    var files = options.files;
    options.collect = options.collect || [ ];
    var self = this;
    var promises = [ ];
    events.EventEmitter.call(this);

    function processNextFile() {
        if (files.length > 0) {
            self.filerecords = 0;
            self.filename = files.shift();
            console.log(self.filename);
            var stream = fs.createReadStream(self.filename);
            self.stream = new XmlStream(stream);
            options.collect.forEach(function (element) {
                self.stream.collect(element);
            });
            self.emit('filestart');
            self.stream.on('end', function() {
                self.emit('filefinish');
            });
            self.stream.on('endElement: ' + options.recordElement, function (record) {
                var promise = Q.defer();
                promises.push(promise.promise);
                if (self.filerecords % 1000 === 0 && self.filerecords > 0) {
                    self.stream.pause();
                    Q.all(promises).then(function () {
                        graphstore.getDB().commitSync();
                        promises = [ ];
                        setTimeout(function () {
                            self.stream.resume();
                        }, 100);
                    });
                }
                self.filerecords++;
                self.emit('record', record, promise);
            });
            return true;
        } else {
            return false;
        }
    }

    this.on('filefinish', function() {
        graphstore.getDB().commitSync();
        console.log("Processed " + self.filerecords + " records in " + self.filename);
        setTimeout(function () {
            if (!processNextFile()) {
                self.emit('done');
            }
        }, 100);
    });

    processNextFile();
}

util.inherits(XMLImporter, events.EventEmitter);

