var util = require('../util');

var parser;

module.exports.initialize = function initQP(config) {
    var grammar = util.loadjisongrammar('qp');

    grammar.lex.rules = [
        [ '["][^"]*["]', "return 'PHR';" ],
        [ '[^<>{}\\[\\]\\s()!:|&]+',   "return 'WORD';" ],
        [ "$",        "return 'EOF';" ],
    ];

    for (var op in config.operators) {
        if (op !== 'FACET_START') {
            grammar.lex.rules.unshift([ config.operators[op], "return '" + op + "';" ]);
        }
    }

    var fieldlist = Object.keys(config.indexes);

    grammar.lex.rules.unshift([ '(' + fieldlist.join('|') + ')\\:', "return 'INDEX';" ]);
    grammar.lex.rules.unshift([ '(' + fieldlist.join('|') + ')' + config.operators.FACET_START, "return 'FACET_START';" ]);
    grammar.lex.rules.unshift([ '\\s+', '/* skip whitespace */' ]);

    parser = util.getjisonparser(grammar);
};

module.exports.parse = function parse(query) {
    parser.yy = { };
    return parser.parse(query);
};

module.exports.name = 'qp';
