var util = require('../util');

var grammar = util.loadjisongrammar('qp');

function QPSyntax(config) {
    var self = this;

    this.parse = function parse(query) {
        self.parser.yy = { };
        return self.parser.parse(query);
    };

    grammar.lex.rules = [
        [ '["][^"]*["]', "return 'PHR';" ],
        [ '[^<>{}\\[\\]\\s()!:|&]+',   "return 'WORD';" ],
        [ "$",        "return 'EOF';" ],
    ];

    for (var op in config.operators) {
        if (op !== 'FACET_START') {
            grammar.lex.rules.unshift([ config.operators[op], "return '" + op + "';" ]);
        }
    }

    var fieldlistre = Object.keys(config.indexes).join('|');

    grammar.lex.rules.unshift([ '(' + fieldlistre + ')\\:', "return 'INDEX';" ]);
    grammar.lex.rules.unshift([ '(' + fieldlistre + ')' + config.operators.FACET_START, "return 'FACET_START';" ]);
    grammar.lex.rules.unshift([ '\\s+', '/* skip whitespace */' ]);

    self.parser = util.getjisonparser(grammar);
    return self;
}

module.exports = QPSyntax;

module.exports.identifier = 'qp';
